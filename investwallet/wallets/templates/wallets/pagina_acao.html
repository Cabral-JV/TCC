{% extends 'base.html' %}
{% load static %}
{% load humanize %}


{% block content %}
<div class="container-fluid mt-5 py-4">
    <div class="position-relative py-3">
        <!-- Título e setor centralizados -->
        <div class="text-center">
            <h2>{{ papel.codigo }} - {{ papel.empresa.nome }}</h2>
        </div>
    
        <!-- Botão fixado no canto direito -->
        <div class="position-absolute top-0 end-0 pt-4 me-3">
            <a href="{% url 'wallets:visualizar_planilha' papel.codigo %}" class="btn btn-danger">
                <i class="bi bi-file-earmark-spreadsheet"></i> Ver Planilha
            </a>
        </div>
    </div>         

    <hr>
    <!-- Tabela de dados -->
    <div class="row">
        <div class="col-md-6">
            <table class="table table-striped table-sm table-bordered table-hover text-center align-middletable">
                <tr class="table-light">
                    <th>Valor de mercado</th>
                    <td>R$ {{ dados_dict.valor_mercado|floatformat:2|intcomma|default:"0,00" }}</td>
                </tr>
                <tr class="table-light">
                    <th>Nº de ações</th>
                    <td>{{ numero_acoes|floatformat:2|intcomma|default:"0,00" }}</td>
                </tr>
                <tr class="table-light">
                    <th>Último balanço</th>
                    <td>{{ ultima_data|date:"d/m/Y" }}</td>
                </tr>
            </table>
        </div>
        <div class="col-md-6">
            <table class="table table-striped table-sm table-bordered table-hover text-center align-middletable">
                <tr class="table-light">
                    <th>Cotação atual</th>
                    <td>R$ {{ ultima_cotacao.preco_fechamento|default:"0,0" }}</td>
                </tr>
                <tr class="table-light">
                    <th>Volume negociado/dia</th>
                    <td>
                        {% if volume is not None %}
                            {{ volume|floatformat:0|intcomma|default:"0,00" }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                <tr class="table-light">
                    <th>Última Cotação</th>
                    <td>{{ ultima_cotacao.data|date:"d/m/Y" | default:"-" }}</td>
                </tr>
            </table>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <table class="table table-striped table-sm table-bordered table-hover text-center align-middletable">
                <tr class="table-light">
                    <th>Valor Intrínseco de Graham</th>
                    <td>R$ {{ dados_dict.graham|floatformat:2|intcomma|default:"0,00" }}</td>
                </tr>
                <tr class="table-light">
                    <th>VPA</th>
                    <td>{{ dados_dict.vpa|floatformat:2|intcomma|default:"0,00" }}</td>
                </tr>
                <tr class="table-light">
                    <th>LPA</th>
                    <td>{{ dados_dict.lpa|floatformat:2|intcomma|default:"0,00" }}</td>
                </tr>
                <tr class="table-light">
                    <th>P/L</th>
                    <td>{{ dados_dict.pl|floatformat:2|intcomma|default:"0,00" }}</td>
                </tr>
                <tr class="table-light">
                    <th>P/VP</th>
                    <td>{{ dados_dict.pvp|floatformat:2|intcomma|default:"0,00" }}</td>
                </tr>
                <tr class="table-light">
                    <th>ROE</th>
                    <td>{{ dados_dict.roe|default:"0,00" }}%</td>
                </tr>
            </table>
        </div>
        <div class="col-md-6">
            <table class="table table-striped table-sm table-bordered table-hover text-center align-middletable">
                <tr class="table-light">
                    <th>Ativo Total</th>
                    <td>R$ {{ dados_dict.ativo_total|floatformat:2|intcomma|default:"0,00" }}</td>
                </tr>
                <tr class="table-light">
                    <th>Ativo Circulante</th>
                    <td>R$ {{ dados_dict.ativo_circulante|floatformat:2|intcomma|default:"0,00" }}</td>
                </tr>
                <tr class="table-light">
                    <th>Caixa e Equivalentes de Caixa</th>
                    <td>R$ {{ dados_dict.caixa_e_equivalentes_de_caixa|floatformat:2|intcomma|default:"0,00" }}</td>
                </tr>
                <tr class="table-light">
                    <th>Patrimônio Líquido</th>
                    <td>R$ {{ dados_dict.patrimonio_liquido|floatformat:2|intcomma|default:"0,00" }}</td>
                </tr>
                <tr class="table-light">
                    <th>Receita Líquida</th>
                    <td>R$ {{ dados_dict.receita_liquida_de_vendas_e_ou_servicos|floatformat:2|intcomma|default:"0,00" }}</td>
                </tr>
                <tr class="table-light">
                    <th>Lucro Líquido</th>
                    <td>R$ {{ dados_dict.lucro_prejuizo_do_periodo|floatformat:2|intcomma|default:"0,00" }}</td>
                </tr>
            </table>
        </div>
    </div>

    <!-- Gráfico -->
    <div class="mt-5">
        <h4>Histórico de Cotações</h4>
        <div id="chart_div" style="width: 100%; height: 400px;"></div>
        <div class="btn-group mt-2" role="group">
            <button class="btn btn-sm btn-danger" onclick="filtrarGrafico('1D')">1 Dia</button>
            <button class="btn btn-sm btn-danger" onclick="filtrarGrafico('7D')">7 Dias</button>
            <button class="btn btn-sm btn-danger" onclick="filtrarGrafico('1M')">1 Mês</button>
            <button class="btn btn-sm btn-danger" onclick="filtrarGrafico('1A')">1 Ano</button>
            <button class="btn btn-sm btn-danger" onclick="filtrarGrafico('5A')">5 Anos</button>
        </div>
    </div>
    

</div>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script>
    const allCotacoes = {{ dados_gcharts|default:'[]'|safe }};
    console.log(allCotacoes.map(c => c.data));

    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(() => filtrarGrafico('1A'));

    function filtrarGrafico(intervalo) {
        const hoje = new Date();
        let dataInicial = new Date();
    
        let cotacoesFiltradas = [];

        if (intervalo === '1D') {
            dataInicial.setDate(hoje.getDate() - 3);
            cotacoesFiltradas = allCotacoes.filter(c => new Date(c.data) >= dataInicial);
        } else {
            if (intervalo === '7D') {
                dataInicial.setDate(hoje.getDate() - 7);
            } else if (intervalo === '1M') {
                dataInicial.setMonth(hoje.getMonth() - 1);
            } else if (intervalo === '1A') {
                dataInicial.setFullYear(hoje.getFullYear() - 1);
            } else if (intervalo === '5A') {
                dataInicial.setFullYear(hoje.getFullYear() - 5);
            }
    
            cotacoesFiltradas = allCotacoes.filter(c => new Date(c.data) >= dataInicial);
        }
    
        const dataArray = [
            ['Data', 'Fechamento'],
            ...cotacoesFiltradas.map(c => [
                new Date(c.data),
                c.preco_fechamento !== null ? c.preco_fechamento : null,
            ])
        ];
    
        const data = google.visualization.arrayToDataTable(dataArray);
    
        const options = {
            title: 'Histórico de Cotações',
            curveType: 'function',
            legend: { position: 'bottom' },
            hAxis: {
                title: 'Data',
                format: 'dd/MM/yyyy',
            },
            vAxis: {
                title: 'Preço (R$)'
            },
            height: 400,
            explorer: { actions: ['dragToZoom', 'rightClickToReset'] },
        };
    
        const chart = new google.visualization.LineChart(document.getElementById('chart_div'));
        chart.draw(data, options);
    }
</script>
{% endblock %}
